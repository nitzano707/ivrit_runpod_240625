<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>Ivrit-AI Transcriber v1.1</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; direction: rtl; background: #f8f8ff; padding: 2em; }
        .box { background: #fff; border-radius: 1.5em; box-shadow: 0 2px 10px #0001; max-width: 430px; margin: auto; padding: 2em; }
        h2 { text-align: center; margin-bottom: 0.2em; }
        .version { text-align: center; font-size: 0.95em; color: #888; margin-bottom: 1em; }
        label { display: block; margin-top: 1em; }
        input[type="file"], input[type="text"] { width: 100%; }
        button { margin-top: 1.5em; width: 100%; padding: 0.7em; border-radius: 1em; border: none; background: #2b5fef; color: #fff; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        button:disabled { background: #aaa; cursor: wait; }
        #progress { margin: 1em 0; text-align: center; font-size: 1em; color: #27408b;}
        #result { margin-top: 2em; background: #f0f4ff; border-radius: 1em; padding: 1em; font-size: 1.1em; min-height: 2em; white-space: pre-wrap; }
        #timer { color: #888; font-size: 0.9em; margin-top: 0.2em;}
        #rawoutput { margin-top: 1.5em; font-size: 0.93em; color: #444; background: #f8f8f8; border-radius: 0.6em; padding: 0.6em; direction: ltr; overflow-x: auto; }
    </style>
</head>
<body>
<div class="box">
    <h2>תמלול עברית עם ivrit.ai</h2>
    <div class="version">Ivrit-AI Transcriber v1.1</div>
    <label>
        מפתח API שלך ב-RunPod:
        <input type="text" id="apiKey" placeholder="הדבק כאן את ה-API KEY שלך">
    </label>
    <label>
        בחר קובץ אודיו (עד 10MB):
        <input type="file" id="audioInput" accept=".mp3,.wav,.m4a,audio/*">
    </label>
    <button id="sendBtn" disabled>העלה ושלח לתמלול</button>
    <div id="progress"></div>
    <div id="timer"></div>
    <div id="result"></div>
    <details id="rawoutput" style="display:none;">
        <summary>פלט JSON מלא</summary>
        <pre id="rawpre"></pre>
    </details>
</div>

<script>
    // הגדרות
    const ENDPOINT_ID = "b7opgnxuuvzhzx"; // שנה לפי הצורך

    // בחירת אלמנטים
    const apiInput = document.getElementById('apiKey');
    const fileInput = document.getElementById('audioInput');
    const sendBtn = document.getElementById('sendBtn');
    const progress = document.getElementById('progress');
    const result = document.getElementById('result');
    const timerDiv = document.getElementById('timer');
    const rawoutput = document.getElementById('rawoutput');
    const rawpre = document.getElementById('rawpre');
    let selectedFile = null;

    apiInput.addEventListener('input', checkReady);
    fileInput.addEventListener('change', e => {
        selectedFile = e.target.files[0];
        checkReady();
    });

    function checkReady() {
        sendBtn.disabled = !(apiInput.value && selectedFile);
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    sendBtn.addEventListener('click', async () => {
        progress.textContent = '';
        result.textContent = '';
        timerDiv.textContent = '';
        rawoutput.style.display = 'none';
        rawpre.textContent = '';
        sendBtn.disabled = true;
        if (!apiInput.value || !selectedFile) {
            progress.textContent = "יש להזין מפתח API ולבחור קובץ";
            sendBtn.disabled = false;
            return;
        }
        if (selectedFile.size > 10 * 1024 * 1024) {
            progress.textContent = "הקובץ גדול מדי (מעל 10MB)";
            sendBtn.disabled = false;
            return;
        }
        progress.textContent = "מעלה קובץ ומבצע שליחה...";
        try {
            const base64 = await fileToBase64(selectedFile);
            progress.textContent = "הקובץ הומר, שולח לשרת...";
            const payload = {
                input: {
                    type: "blob",
                    data: base64,
                    model: "ivrit-ai/whisper-large-v3-turbo-ct2",
                    engine: "faster-whisper"
                }
            };
            const url = `https://api.runpod.ai/v2/${ENDPOINT_ID}/run`;
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": apiInput.value.trim()
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error("שגיאת שרת: " + response.status);
            }

            const data = await response.json();
            // נבדוק האם יש id - אם כן צריך לפול (polling)
            if (data.id) {
                progress.textContent = "הבקשה בתור... מחכה לתוצאה (10-60 שניות)";
                await pollForResult(data.id, apiInput.value.trim());
            } else if (data.output && data.output.text) {
                // קיבלנו תוצאה מיידית (נדיר)
                result.textContent = data.output.text;
                progress.textContent = "הסתיים בהצלחה!";
            } else {
                result.textContent = JSON.stringify(data, null, 2);
                progress.textContent = "קיבלנו תגובה לא צפויה.";
            }
        } catch (err) {
            result.textContent = "שגיאה: " + err.message;
            progress.textContent = "נכשל.";
        }
        sendBtn.disabled = false;
    });

    // פונקציית polling לקבלת תוצאה מהשרת
    async function pollForResult(jobId, apiKey) {
        const statusUrl = `https://api.runpod.ai/v2/${ENDPOINT_ID}/status/${jobId}`;
        let status = "";
        let start = Date.now();
        let count = 0;
        while (count < 60) { // עד דקה (60 סבבים של שניה)
            timerDiv.textContent = `המתנה: ${(Date.now()-start)/1000|0} שניות...`;
            await new Promise(r => setTimeout(r, 2000)); // המתן 2 שניות
            const res = await fetch(statusUrl, {
                method: "GET",
                headers: { "Authorization": apiKey }
            });
            if (!res.ok) {
                result.textContent = "שגיאת polling: " + res.status;
                progress.textContent = "התקשורת נכשלה.";
                timerDiv.textContent = "";
                return;
            }
            const data = await res.json();
            status = data.status;
            // הצגת JSON מלא:
            rawoutput.style.display = "block";
            rawpre.textContent = JSON.stringify(data, null, 2);
            // ניסיון לתמצת תוצאה:
            if (status === "COMPLETED") {
                let text = "";
                // בדיקת פורמט תוצאה: output.text או output.result
                if (data.output) {
                    if (typeof data.output.text === "string") {
                        text = data.output.text;
                    } else if (Array.isArray(data.output.result)) {
                        // מחבר את כל הקטעים לשרשור
                        text = data.output.result.map(seg => seg.text).join(" ");
                    } else {
                        text = JSON.stringify(data.output);
                    }
                }
                result.textContent = text || "לא נמצאה תוצאה מילולית.";
                progress.textContent = "הסתיים בהצלחה!";
                timerDiv.textContent = "";
                return;
            } else if (status === "FAILED") {
                result.textContent = "שגיאת עיבוד: " + (data.output?.error || "לא ידועה");
                progress.textContent = "נכשל.";
                timerDiv.textContent = "";
                return;
            }
            count++;
        }
        progress.textContent = "עבר הזמן המקסימלי. נסה שוב או נסה קובץ קצר יותר.";
        timerDiv.textContent = "";
    }
</script>
</body>
</html>
