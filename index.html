<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>תמלול עברית עם ivrit.ai (RunPod)</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; direction: rtl; background: #f8f8ff; padding: 2em; }
        .box { background: #fff; border-radius: 1.5em; box-shadow: 0 2px 10px #0001; max-width: 420px; margin: auto; padding: 2em; }
        h2 { text-align: center; margin-bottom: 1em; }
        label { display: block; margin-top: 1em; }
        input[type="file"], input[type="text"] { width: 100%; }
        button { margin-top: 1.5em; width: 100%; padding: 0.7em; border-radius: 1em; border: none; background: #2b5fef; color: #fff; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        button:disabled { background: #aaa; cursor: wait; }
        #progress { margin: 1em 0; text-align: center; font-size: 1em; color: #27408b;}
        #result { margin-top: 2em; background: #f0f4ff; border-radius: 1em; padding: 1em; font-size: 1.1em; min-height: 2em; white-space: pre-wrap; }
    </style>
</head>
<body>
<div class="box">
    <h2>תמלול עברית עם ivrit.ai</h2>
    <label>
        מפתח API שלך ב-RunPod:
        <input type="text" id="apiKey" placeholder="הדבק כאן את ה-API KEY שלך">
    </label>
    <label>
        בחר קובץ אודיו (עד 10MB):
        <input type="file" id="audioInput" accept=".mp3,.wav,.m4a,audio/*">
    </label>
    <button id="sendBtn" disabled>העלה ושלח לתמלול</button>
    <div id="progress"></div>
    <div id="result"></div>
</div>

<script>
    const apiInput = document.getElementById('apiKey');
    const fileInput = document.getElementById('audioInput');
    const sendBtn = document.getElementById('sendBtn');
    const progress = document.getElementById('progress');
    const result = document.getElementById('result');
    let selectedFile = null;

    apiInput.addEventListener('input', checkReady);
    fileInput.addEventListener('change', e => {
        selectedFile = e.target.files[0];
        checkReady();
    });

    function checkReady() {
        sendBtn.disabled = !(apiInput.value && selectedFile);
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    sendBtn.addEventListener('click', async () => {
        progress.textContent = '';
        result.textContent = '';
        sendBtn.disabled = true;
        if (!apiInput.value || !selectedFile) {
            progress.textContent = "יש להזין מפתח API ולבחור קובץ";
            sendBtn.disabled = false;
            return;
        }
        if (selectedFile.size > 10 * 1024 * 1024) {
            progress.textContent = "הקובץ גדול מדי (מעל 10MB)";
            sendBtn.disabled = false;
            return;
        }
        progress.textContent = "מעלה קובץ ומבצע שליחה...";

        try {
            const base64 = await fileToBase64(selectedFile);
            progress.textContent = "הקובץ הומר, שולח לשרת...";
            const payload = {
                input: {
                    type: "blob",
                    data: base64,
                    model: "ivrit-ai/whisper-large-v3-turbo-ct2",
                    engine: "faster-whisper"
                }
            };
            const response = await fetch("https://api.runpod.ai/v2/b7opgnxuuvzhzx/run", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": apiInput.value.trim()
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error("שגיאת שרת: " + response.status);
            }
            progress.textContent = "ממתין לתוצאה...";
            const data = await response.json();
            // תוצאה טיפוסית: { id, status, output, ... }
            if (data.output && data.output.text) {
                result.textContent = data.output.text;
                progress.textContent = "הסתיים בהצלחה!";
            } else if (data.status === "FAILED") {
                result.textContent = "שגיאת עיבוד: " + (data.output?.error || "לא ידועה");
                progress.textContent = "נכשל.";
            } else {
                result.textContent = JSON.stringify(data, null, 2);
                progress.textContent = "קיבלנו תגובה לא צפויה.";
            }
        } catch (err) {
            result.textContent = "שגיאה: " + err.message;
            progress.textContent = "נכשל.";
        }
        sendBtn.disabled = false;
    });
</script>
</body>
</html>
